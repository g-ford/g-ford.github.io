<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.a24f2b4d75db3af0c9ed.css">@font-face{font-family:Oswald;font-style:normal;font-display:swap;font-weight:200;src:local("Oswald Extra Light "),local("Oswald-Extra Light"),url(/static/oswald-latin-200-7de4e8c7241042bac22064babb6649a6.woff2) format("woff2"),url(/static/oswald-latin-200-74b035507786c9fa80f85f11d92a502c.woff) format("woff")}@font-face{font-family:Oswald;font-style:normal;font-display:swap;font-weight:300;src:local("Oswald Light "),local("Oswald-Light"),url(/static/oswald-latin-300-dc15f3b07cb711e818ecb48de992992c.woff2) format("woff2"),url(/static/oswald-latin-300-d2c191b2e46f060bf90b34e6b3f73d83.woff) format("woff")}@font-face{font-family:Oswald;font-style:normal;font-display:swap;font-weight:400;src:local("Oswald Regular "),local("Oswald-Regular"),url(/static/oswald-latin-400-f15aa285863274b4f6ed578caa76565e.woff2) format("woff2"),url(/static/oswald-latin-400-ca70f49a133f08485bd05d5cb28ef8b7.woff) format("woff")}@font-face{font-family:Oswald;font-style:normal;font-display:swap;font-weight:500;src:local("Oswald Medium "),local("Oswald-Medium"),url(/static/oswald-latin-500-541a863959122f29c9961095cdcbb5c2.woff2) format("woff2"),url(/static/oswald-latin-500-deebf8fc5d31111f3144d0c6373143cc.woff) format("woff")}@font-face{font-family:Oswald;font-style:normal;font-display:swap;font-weight:600;src:local("Oswald SemiBold "),local("Oswald-SemiBold"),url(/static/oswald-latin-600-b81a3735849bb304ae25ae10c748d5ab.woff2) format("woff2"),url(/static/oswald-latin-600-452513e2767e99884b1c084dad03126b.woff) format("woff")}@font-face{font-family:Oswald;font-style:normal;font-display:swap;font-weight:700;src:local("Oswald Bold "),local("Oswald-Bold"),url(/static/oswald-latin-700-3e941c0d10bcb614ac1442884055d2bf.woff2) format("woff2"),url(/static/oswald-latin-700-7eb521f12cd966b030825fa662677353.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.1.24"/><style data-styled="fbJHg gxsCvX SzhqG farUpD eXxOgn kcLgnJ eQQcmK loUmBT bUjgIC nTaEa eUgifa coHVso fLOoNf lczczh" data-styled-version="4.1.3">
/* sc-component-id: styled-link__StyledLink-evpd30-0 */
.gxsCvX{-webkit-text-decoration:none;text-decoration:none;color:rgba(0,0,0,0.8);}
/* sc-component-id: header__Container-q6n5p1-0 */
.fbJHg{box-shadow:0 4px 12px 0 rgba(0,0,0,0.05);height:6rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}
/* sc-component-id: header__Title-q6n5p1-1 */
.SzhqG{font-size:1.6rem;font-weight:800;-webkit-letter-spacing:0.1rem;-moz-letter-spacing:0.1rem;-ms-letter-spacing:0.1rem;letter-spacing:0.1rem;text-transform:uppercase;margin:0;} @media (max-width:36em){.SzhqG{text-align:center;}}
/* sc-component-id: sc-global-486307597 */
@font-face{font-family:system;font-style:normal;font-weight:300;src:local('.SFNSText-Light'),local('.HelveticaNeueDeskInterface-Light'), local('.LucidaGrandeUI'),local('Ubuntu Light'),local('Segoe UI Light'), local('Roboto-Light'),local('DroidSans'),local('Tahoma');} :root{font-size:10px;} body{font-family:'system';margin:0;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;color:rgba(0,0,0,0.8);min-height:100vh;position:relative;font-size:1.6rem;} h1,h2,h3,h4,h5,h6{font-family:'Oswald',sans-serif;} h2{font-size:2.5rem;} h3{font-size:2.4rem;} h4{font-size:1.6rem;} code{font-family:Menlo,Monaco,"Courier New",Courier,monospace;word-break:break-word;} pre code{word-break:normal;} :not(pre) > code[class*="language-"],pre[class*="language-text"]{background-color:transparent;color:inherit;font-size:medium;}
/* sc-component-id: layout__Footer-sc-13bvcqm-0 */
.lczczh{display:block;height:6rem;}
/* sc-component-id: layout__Content-sc-13bvcqm-1 */
.farUpD{width:60%;max-width:728px;margin:0 auto;} @media (max-width:48em){.farUpD{width:80%;}}
/* sc-component-id: post-styles__Tags-e9edps-0 */
.bUjgIC{list-style:none;margin:0 -5px;padding:0;} .bUjgIC li{display:inline-block;margin:0.625rem 0.3125rem;} .bUjgIC li a{background:#ebebeb;-webkit-text-decoration:none;text-decoration:none;border:0;border-radius:0.1875rem;color:#555;line-height:1.625;padding:0.5rem 1rem;}
/* sc-component-id: post-styles__Container-e9edps-1 */
.eXxOgn{margin-top:8rem;} @media (max-width:36em){.eXxOgn{margin-top:4rem;}} .eXxOgn p{line-height:1.5;} .eXxOgn blockquote{margin-left:0.25rem;font-size:1.6rem;color:inherit;font-style:italic;border-left:0.2rem solid rgb(0,0,0);padding-left:1rem;margin:1rem 0;} .eXxOgn pre{margin-bottom:2rem;} .eXxOgn h3{line-height:1.13;} .eXxOgn h2,.eXxOgn h3,.eXxOgn h4,.eXxOgn h5,.eXxOgn h6{margin:2rem 0 2rem;} .eXxOgn hr{border:0;border-top:0.1rem solid #ccc;display:block;height:1rem;padding:0;} .eXxOgn .gatsby-highlight pre{display:block;position:relative;padding:20px 0 0;background:#193549;color:#dcdcdc;border-radius:5px;overflow-y:hidden;} .eXxOgn .gatsby-highlight pre:before{display:inline-block;position:absolute;top:15px;left:20px;width:10px;height:10px;background-color:#ff5f56;border-radius:50%;content:'';} .eXxOgn .gatsby-highlight pre:after{display:inline-block;position:absolute;top:15px;left:40px;width:10px;height:10px;background-color:#ffbd2e;border-radius:50%;content:'';} .eXxOgn .gatsby-highlight pre code:before{display:inline-block;position:absolute;top:15px;left:60px;width:10px;height:10px;background-color:#27c93f;border-radius:50%;content:'';} .eXxOgn .gatsby-highlight pre code{background:none;border:none;border-radius:3px;display:inline-block;overflow:inherit;padding:1.58333rem;white-space:inherit;word-wrap:normal;font-family:Inconsolata,monospace;} .eXxOgn .gatsby-highlight code{-moz-border-radius:3px;-webkit-border-radius:3px;white-space:pre;white-space:pre-wrap;white-space:pre-line;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:-moz-pre-wrap;white-space:-hp-pre-wrap;word-wrap:break-word;background:transparent;color:#3b9cff;display:inline;font-family:D2Coding,'D2 coding',monospace,serif;max-width:100%;overflow:auto;padding:0 0.1625rem;} .eXxOgn .gatsby-highlight pre code{color:#dcdcdc;}
/* sc-component-id: post-styles__Header-e9edps-2 */
@media (max-width:48em){.kcLgnJ{text-align:center;}}
/* sc-component-id: post-styles__Title-e9edps-3 */
.eQQcmK{margin-bottom:1rem;font-size:3rem;}
/* sc-component-id: post-styles__LinkList-e9edps-4 */
.fLOoNf{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0px;}
/* sc-component-id: share__Container-awx3z1-0 */
.eUgifa{margin:1rem 0 5rem;} .eUgifa .social-icon{display:inline-block;margin:0 0.5rem;cursor:pointer;}
/* sc-component-id: sc-bdVaJa */
.coHVso{font-size:1.4rem;color:rgb(0,0,0);}
/* sc-component-id: sc-bwzfXH */
.loUmBT{color:rgba(0,0,0,0.8);}
/* sc-component-id: sc-htpNat */
.nTaEa{margin:5rem 0;}</style><title data-react-helmet="true">Python Meta-Programming with APIs | Geoff wrote this</title><meta data-react-helmet="true" name="description" content="Meta-programming techniques can help turn some very ugly, repetative code into simple, beautiful code that is considerably easier to use…"/><meta data-react-helmet="true" property="og:title" content="Python Meta-Programming with APIs"/><meta data-react-helmet="true" property="og:description" content="Meta-programming techniques can help turn some very ugly, repetative code into simple, beautiful code that is considerably easier to use…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Geoff Ford"/><meta data-react-helmet="true" name="twitter:title" content="Python Meta-Programming with APIs"/><meta data-react-helmet="true" name="twitter:description" content="Meta-programming techniques can help turn some very ugly, repetative code into simple, beautiful code that is considerably easier to use…"/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png"/><link as="script" rel="preload" href="/webpack-runtime-69316ea9b98891155c87.js"/><link as="script" rel="preload" href="/styles-a4948228b5f42944b119.js"/><link as="script" rel="preload" href="/app-c109402871fdce1c432e.js"/><link as="script" rel="preload" href="/0-3a9e885adcf37575f6be.js"/><link as="script" rel="preload" href="/11-5fc4ddf496fdc7b34968.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-24201906f4478a863d6b.js"/><link as="fetch" rel="preload" href="/static/d/862/path---python-metaprogramming-with-apis-9-ce-fd5-xE9bB3U9bVx3VXglkF3lXJrzgKo.json" crossorigin="use-credentials"/></head><body><noscript>Sorry! This site requires JavaScript to be enabled.</noscript><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><nav class="header__Container-q6n5p1-0 fbJHg"><a class="styled-link__StyledLink-evpd30-0 gxsCvX" href="/"><h1 class="header__Title-q6n5p1-1 SzhqG">Geoff wrote this</h1></a></nav><div class="layout__Content-sc-13bvcqm-1 farUpD"><article class="post-styles__Container-e9edps-1 eXxOgn"><header class="post-styles__Header-e9edps-2 kcLgnJ"><h1 class="post-styles__Title-e9edps-3 eQQcmK">Python Meta-Programming with APIs</h1><sub class="sc-bwzfXH loUmBT"><span>Posted on <!-- -->May 12, 2015</span><span>  -  </span><span>9 min read</span></sub><div class="post-single__tags"><ul class="post-styles__Tags-e9edps-0 bUjgIC"><li class="post-single__tags-list-item"><a class="post-single__tags-list-item-link" href="/tags/python">python</a></li><li class="post-single__tags-list-item"><a class="post-single__tags-list-item-link" href="/tags/apis">apis</a></li></ul></div></header><div class="sc-htpNat nTaEa"><p>Meta-programming techniques can help turn some very ugly, repetative code into simple, beautiful code that is considerably easier to use. This article will show the application of some <em>basic</em> python meta-programming techniques and how they were used to put a pythonic interface atop an obviously java based API.</p>
<p>The final code is <a href="https://github.com/alephnullplex/trendy">avialable on Github</a> and <a href="https://pypi.python.org/pypi/trendy/">PyPi</a></p>
<h2>In the beginning</h2>
<p>I have recently needed to interact with the <a href="http://www.trendmicro.com.au/au/enterprise/cloud-solutions/deep-security/">Trend Micro Deep Security</a> SOAP API via python. The initial attempt used <a href="https://fedorahosted.org/suds/">suds</a> in a pretty straight forward manner. This is a representative example that retrieves a list of <code class="language-text">host</code> objects from Trend.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_hosts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lookup<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> many<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get a host, or list of hosts from Trend.

    If `lookup` is a string, find the matching host by name.
    If `lookp` is a number, find the matching host by id.
    If not `lookup` and `many` is True, get all hosts from trend.
    """</span>

    trend_connection <span class="token operator">=</span> TrendConnectionFactory<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">,</span> self<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pwd<span class="token punctuation">)</span>
    trend_connection<span class="token punctuation">.</span>authenticate<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># this logs in and gets a session id (sid)</span>

    <span class="token keyword">if</span> trend_connection<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
        <span class="token comment"># ...log and return</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> lookup <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">and</span> many<span class="token punctuation">:</span>
            result <span class="token operator">=</span> trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>hostRetrieveAll<span class="token punctuation">(</span>trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>hostRetrieve<span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>hostRetrieveByName<span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>

        trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>endSession<span class="token punctuation">(</span>trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>

    <span class="token keyword">except</span> suds<span class="token punctuation">.</span>WebFault <span class="token keyword">as</span> detail<span class="token punctuation">:</span>
        trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>endSession<span class="token punctuation">(</span>trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>
        <span class="token comment"># ...log and return</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>endSession<span class="token punctuation">(</span>trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>
        <span class="token comment"># ...log and return</span>

    default <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment"># it was more complicated than this...</span>
    <span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> default
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        result</code></pre></div>
<p>The trend API is surprising consistent. There are a number of resources such as <code class="language-text">Host</code>, <code class="language-text">FirewallRule</code>, <code class="language-text">SecurityProfile</code> etc with the same basic endpoints: <code class="language-text">retrieve</code>, <code class="language-text">retrieveAll</code>, <code class="language-text">retrieveByName</code>, <code class="language-text">save</code> and <code class="language-text">delete</code>. With at least 7 resources with 5 endpoints we ended up copying the above pattern over 35 times.</p>
<h3>Goals</h3>
<p>My high level goals were to make it easier to use the API and look more pythonic. There are some initial glaring issues with the first attempt.</p>
<p>Session management is a very manual process. You have to explicitly log in, pass around the session id to every subsequent call and then explicitly end the session. This ended up being a very important issue as Trend allows admins to configure the number of concurrent sessions an API user can initiate. We hit the default limit pretty quickly jsut with the number of developers running tests trying to connect.</p>
<p>Another issue is this method is trying to do too much by having <code class="language-text">lookup</code> overloaded and a bit cumbersome by making <code class="language-text">lookup</code> and <code class="language-text">many</code> co-related.</p>
<p>A less obvious issue is the unpleasant verboseness of using suds. Having <code class="language-text">client.service</code> repeated for no real reason just clogs up the code. Additionally the camel case naming of the SOAP methods causes pylint to throw up some issues.</p>
<p>Finally the exception handling is biolerplate that adds little value so we will elimate that completely.</p>
<h2>Adding some context</h2>
<p>Where some action must be taken before and/or after a block of code is a pattern that python calls context management. Most of the time this pattern is used for resource management - releasing files, database connections, locks etc.</p>
<p>We will add an <code class="language-text">__enter__</code> and <code class="language-text">__exit__</code> method to our connection class which enable it to be used as a context manager.<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup></p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TrendConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> url<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> pwd<span class="token punctuation">,</span> environment<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># set up Suds connection</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sid <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>authenticate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pwd<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>client <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>endSession<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sid<span class="token punctuation">)</span></code></pre></div>
<p>This only slightly improved the pattern by removing the explicit calls to <code class="language-text">authenticate</code> and <code class="language-text">endSession</code>. It had a huge impact on the <strong>reliability</strong> of the code though as we always close the session correctly. There is no longer the risk that any new code would forget to <code class="language-text">endSession</code>.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_hosts</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> lookup<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> many<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Get a host, or list of hosts from Trend.

    If `lookup` is a string, find the matching host by name.
    If `lookup` is a number, find the matching host by id.
    If not `lookup` and `many` is True, get all hosts from trend.
    """</span>
    <span class="token keyword">with</span> TrendConnection<span class="token punctuation">(</span>self<span class="token punctuation">.</span>url<span class="token punctuation">,</span> self<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> self<span class="token punctuation">.</span>pwd<span class="token punctuation">)</span> <span class="token keyword">as</span> trend_connection<span class="token punctuation">:</span>
        <span class="token keyword">if</span> lookup <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">and</span> many<span class="token punctuation">:</span>
            result <span class="token operator">=</span> trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>hostRetrieveAll<span class="token punctuation">(</span>trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lookup<span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>hostRetrieve<span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> trend_connection<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">.</span>hostRetrieveByName<span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> trend_connection<span class="token punctuation">.</span>sid<span class="token punctuation">)</span>

        default <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> result <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> default
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result</code></pre></div>
<h3>Removing explicit session management</h3>
<p>The next goal was to remove the need to pass the session id around. The consistency of the Trend API was a huge benefit. It always put the session id in the last argument position. Anything that is consistent can be automated.</p>
<p>The idea is to intercept any calls to the API endpoints and inject the session id in the last position in the arguments list so the developer doesn’t have to.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># what we want to do</span>
<span class="token keyword">with</span> TrendConnection<span class="token punctuation">(</span>wsdl<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token keyword">pass</span><span class="token punctuation">)</span> <span class="token keyword">as</span> trend<span class="token punctuation">:</span>
    host <span class="token operator">=</span> trend<span class="token punctuation">.</span>client<span class="token punctuation">.</span>services<span class="token punctuation">.</span>hostRetrieveByName<span class="token punctuation">(</span><span class="token string">'some_host'</span><span class="token punctuation">)</span>
    host<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"New name"</span>
    trend<span class="token punctuation">.</span>client<span class="token punctuation">.</span>services<span class="token punctuation">.</span>hostSave<span class="token punctuation">(</span>host<span class="token punctuation">)</span></code></pre></div>
<p>Here we start to actually use some meta-programming techniques. A lot of Python meta-programming hinges on a pair of functions - <code class="language-text">getattr</code> and <code class="language-text">setattr</code> - and their related double underscore versions. This family of functions allows us to inspect an objects attributes. In a dynamic language we can also use them to create attributes. <sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup></p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TrendConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attribute_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">def</span> <span class="token function">_wrapped</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
            args <span class="token operator">=</span> args <span class="token operator">+</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token punctuation">,</span> attribute_name<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span>

        <span class="token keyword">return</span> _wrapped</code></pre></div>
<p>Here we are intercepting unknown attributes<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> and assume they are a function call to the SOAP endpoints. The session id is added to the list of arguments and then we use <code class="language-text">getattr</code> to actually invoke the function with the new args. This is all wrapped up and passed back to the caller.</p>
<p>This approach ends up being slightly nicer as it removes the cumbersome <code class="language-text">client.services</code> and the session id so we end up with client code like so.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">with</span> TrendConnection<span class="token punctuation">(</span>wsdl<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token keyword">pass</span><span class="token punctuation">)</span> <span class="token keyword">as</span> trend<span class="token punctuation">:</span>
    host <span class="token operator">=</span> trend<span class="token punctuation">.</span>hostRetrieveByName<span class="token punctuation">(</span><span class="token string">'some_host'</span><span class="token punctuation">)</span>
    host<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"New name"</span>
    trend<span class="token punctuation">.</span>hostSave<span class="token punctuation">(</span>host<span class="token punctuation">)</span></code></pre></div>
<h2>Many endpoints, same pattern</h2>
<p>Again, Trends API consistency gives us more opportunites. Each of the resource types have the same set of endpoints avaialable, but the endpoints are decidedly not pythonic. We can fix that.</p>
<p>We’ll create a simple interface that all services will follow.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ServiceBase</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trend<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	self<span class="token punctuation">.</span>trend <span class="token operator">=</span> trend

    <span class="token keyword">def</span> <span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Return a collection of all the objects in Trend
        """</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">by_id</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span>
        <span class="token triple-quoted-string string">"""
        Get a single object using the Trend ID
        """</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">by_ids</span><span class="token punctuation">(</span>slef<span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Get a collection of objects using ids
        """</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>by_id<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token builtin">id</span> <span class="token keyword">in</span> ids<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">by_name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Get a single object using the Trend name
        """</span>
        <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">by_names</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Get a collection of objects using names
        """</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>by_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">for</span> name <span class="token keyword">in</span> names<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	<span class="token triple-quoted-string string">"""
    	Create or update the item in Trend.
    	"""</span>
    	<span class="token keyword">pass</span></code></pre></div>
<p>This is a pretty basic interface but it looks much better to our snake eyes. Let’s go ahead and implement one.</p>
<h3>Creating a service</h3>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">HostService</span><span class="token punctuation">(</span>ServiceBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> trend<span class="token punctuation">.</span>hostsRetrieveAll<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">by_id</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> trend<span class="token punctuation">.</span>hostsRetrieveByID<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">by_name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> trend<span class="token punctuation">.</span>hostsRetrieveByName<span class="token punctuation">(</span>name<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> trend<span class="token punctuation">.</span>hostsSave<span class="token punctuation">(</span>item<span class="token punctuation">)</span></code></pre></div>
<p>So we can copy and paste that and replace all mention of <code class="language-text">host</code> with <code class="language-text">firewallRule</code> or <code class="language-text">securityProfile</code> etc. for the other services. But I’m not a real fan of copy and paste. I think we can do even better than this.</p>
<p>Notice that all the endpoints start with a common prefix that represents the resource and all the actions are the same. What is consistent, can be automated.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ServiceBase</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trend<span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">:</span>
    	self<span class="token punctuation">.</span>trend <span class="token operator">=</span> trend
    	self<span class="token punctuation">.</span>_prefix <span class="token operator">=</span> prefix

    <span class="token comment"># the other base methods can be implmented in a similar fashion</span>
    <span class="token keyword">def</span> <span class="token function">all</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>trend<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_prefix <span class="token operator">+</span> <span class="token string">'RetrieveAll'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">HostService</span><span class="token punctuation">(</span>ServiceBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trend<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>HostService<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>trend<span class="token punctuation">,</span> <span class="token string">'hosts'</span><span class="token punctuation">)</span></code></pre></div>
<p>Here we have a default implementation in the base class using a <code class="language-text">prefix</code> to determine which method to call on trend via <code class="language-text">getattr</code>.</p>
<p>Adding additonal resources is now only three lines of code instead of overriding all the methods.</p>
<p>Let’s see what this api looks like now.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">with</span> TrendConnection<span class="token punctuation">(</span>wsdl<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token keyword">pass</span><span class="token punctuation">)</span> <span class="token keyword">as</span> trend<span class="token punctuation">:</span>
    host_service <span class="token operator">=</span> HostService<span class="token punctuation">(</span>trend<span class="token punctuation">)</span>
    host <span class="token operator">=</span> host_service<span class="token punctuation">.</span>by_name<span class="token punctuation">(</span><span class="token string">'some_name'</span><span class="token punctuation">)</span>
    host<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"New name"</span>
    host_service<span class="token punctuation">.</span>save<span class="token punctuation">(</span>host<span class="token punctuation">)</span></code></pre></div>
<p>This is considerably nicer than where we began. But I think we can still do better.</p>
<h2>Auto-creating the services</h2>
<p>Needing to manually instatiate each service is a little bit annoying. Something like this would be even simpler.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">with</span> TrendConnection<span class="token punctuation">(</span>wsdl<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token keyword">pass</span><span class="token punctuation">)</span> <span class="token keyword">as</span> trend<span class="token punctuation">:</span>
    host <span class="token operator">=</span> trend<span class="token punctuation">.</span>hosts<span class="token punctuation">.</span>by_name<span class="token punctuation">(</span><span class="token string">'some_name'</span><span class="token punctuation">)</span>
    host<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"New name"</span>
    trend<span class="token punctuation">.</span>hosts<span class="token punctuation">.</span>save<span class="token punctuation">(</span>host<span class="token punctuation">)</span></code></pre></div>
<p>This will be a lot simpler particularly when we need to start interacting with multiple resources. To do this we can simply add each service as an attribute to the <code class="language-text">TrendConnection</code> class. But, again, I don’t like typing that all in. When I add another <code class="language-text">Service</code> I just want it to automatically be available.</p>
<p>This is easily acheivable by getting the list of <code class="language-text">Service</code> classes and adding them to the <code class="language-text">Connection</code> object using <code class="language-text">setattr</code>.</p>
<div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TrendConnection</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># usual setup</span>
        self<span class="token punctuation">.</span>_add_services<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_add_services</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        all_services <span class="token operator">=</span> <span class="token punctuation">[</span>service <span class="token keyword">for</span> service <span class="token keyword">in</span> <span class="token builtin">dir</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span>
                          <span class="token keyword">if</span> service<span class="token punctuation">.</span>name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'Service'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> service <span class="token keyword">in</span> all_services<span class="token punctuation">:</span>
            <span class="token builtin">setattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> snake_case<span class="token punctuation">(</span>service<span class="token punctuation">.</span>__class__<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span></code></pre></div>
<p>You may have noticed that I called the <code class="language-text">ServiceBase</code> a slightly different naming format to the <code class="language-text">HostService</code>. This is so that I can easily identify actual services in the <code class="language-text">services</code> module and then attach them to the connection object.</p>
<p>The <code class="language-text">snake_case</code> function is a simple one that turns CamelCase into a snake_case so that the attributes pass pylint.</p>
<h2>Conclusion</h2>
<p>The final results of the API usage are considerably cleaner and definately more pythonic. Adding new services is now a simple three line affair rather than having to copy and paste a lot of boiler plate.</p>
<p>All this comes at a small cost of developer understanding. We had to document very well as some of the code was not immediately obvious to less experienced developers.</p>
<div class="footnotes">
<hr>
<ol>
<li id="fn-1">
<p>For a more thorough intoduction to context managers see <a href="http://preshing.com/20110920/the-python-with-statement-by-example/">Python with statement by example</a> or <a href="https://www.python.org/dev/peps/pep-0343/">PEP343</a></p>
<a href="#fnref-1" class="footnote-backref">↩</a>
</li>
<li id="fn-2">
<p>For a more thorough introduction to these functions see <a href="http://chase-seibert.github.io/blog/2013/04/12/getattr-setattr.html">this blog post</a>.</p>
<a href="#fnref-2" class="footnote-backref">↩</a>
</li>
<li id="fn-3">
<p>In the real code there is a <a href="https://github.com/alephnullplex/trendy/blob/master/trendy/connection.py#L69">list of known method calls</a> to validate against. This avoids some runtime errors trying to invoke a method that does not exist.</p>
<a href="#fnref-3" class="footnote-backref">↩</a>
</li>
</ol>
</div></div><div class="share__Container-awx3z1-0 eUgifa"><p class="sc-bdVaJa coHVso">Share if you liked it:</p></div><ul class="post-styles__LinkList-e9edps-4 fLOoNf"><li><a rel="prev" href="/isomorphic-react-from-scratch/">← <!-- -->Isomorphic React from Scratch: Hello Isomorphism</a></li><li><a rel="next" href="/dotnet-serverless/">dotnet in a Serverless world<!-- --> →</a></li></ul></article></div><footer class="layout__Footer-sc-13bvcqm-0 lczczh"></footer></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'undefined', 'auto', {});
      
      
      
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"python-metaprogramming-with-apis-9ce","path":"/python-metaprogramming-with-apis/"};window.dataPath="862/path---python-metaprogramming-with-apis-9-ce-fd5-xE9bB3U9bVx3VXglkF3lXJrzgKo";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-c109402871fdce1c432e.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-2fd931839064a91a4c0f.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-24201906f4478a863d6b.js"],"component---src-templates-tag-js":["/component---src-templates-tag-js-aa0ac24bdb7ca89cf8df.js"],"component---src-pages-404-js":["/component---src-pages-404-js-c2db48b72e8dd5db8e38.js"],"component---src-pages-index-js":["/component---src-pages-index-js-b2c142de0d2c7a03d420.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-0fc340f5b7bdc09cc2b4.js"],"pages-manifest":["/pages-manifest-ed5bfbb7c068e8e17bac.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-24201906f4478a863d6b.js" async=""></script><script src="/11-5fc4ddf496fdc7b34968.js" async=""></script><script src="/0-3a9e885adcf37575f6be.js" async=""></script><script src="/app-c109402871fdce1c432e.js" async=""></script><script src="/styles-a4948228b5f42944b119.js" async=""></script><script src="/webpack-runtime-69316ea9b98891155c87.js" async=""></script></body></html>