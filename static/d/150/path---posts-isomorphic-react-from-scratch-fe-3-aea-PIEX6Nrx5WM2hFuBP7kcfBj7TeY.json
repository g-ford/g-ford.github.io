{"data":{"site":{"siteMetadata":{"title":"Geoff wrote this","subtitle":"Things I wrote, but probably aren't important","copyright":"© All rights reserved.","author":{"name":"Geoff Ford","twitter":"geoffford16"},"disqusShortname":"","url":"https://lumen.netlify.com"}},"markdownRemark":{"id":"c679fe64-f696-5ecc-b0fa-1afa0ceb14c7","html":"<p>Isomorphic javascript is the new cool in the web development world. This is my journey learning what isomorphic javscript is and how one would go about building a site or application the way the cool kids do.</p>\n<p>I have a lot of experience with a number of different web application langauges and frameworks. From old school things like PHPNuke to Ruby on Rails, MVC.Net, Django and Flask, and more recently Angular, I have seen a lot of different ways to build a web application.</p>\n<p>Most recently I have been building Django backends with Django Rest Framework and Angular front ends. However, with the sharp change in direction that Angular 2 is taking I thought it was time to look around a bit more and see what else was available.</p>\n<p>After some extensive research (lasting approximately 10 minutes) I decided that my current project should be based on React using a Flux achitecture with a Node backend and therefore I should look at isomorphism. That’s a lot of new technology and ideas to wrap my head around for a small project but I had the time and the freedom.</p>\n<h2>Iso who?</h2>\n<blockquote>\n<p><strong>isomorphic</strong> - <em>adjective</em> - corresponding or similar in form and relations.\n— <cite><a href=\"//www.oxforddictionaries.com/definition/english/isomorphic\">Oxford Dictionary</a></cite></p>\n</blockquote>\n<p>An isomorphic application is one that uses the same code on the front end and the back end. Most often this means using node on the backend and a tool to make the back end code work on the front end<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>. In the end you write (mostly) one set of code that can be rendered either in node or in the browser.</p>\n<p>There are a <a href=\"//isomorphic.net/libraries\">large number of frameworks and libraries</a> to help you build an isomorphic application but for this series I will be coding many of the building blocks from scratch.</p>\n<h2>What to build</h2>\n<p>Rather than build the typical blog or to do list sample project I’m going to build something fun - a simple guessing game based on social media. It will pick a random image or post from your social sphere and present multiple choice options for you to guess which of your friends posted it. This will provide us with some good learning opportunites such as</p>\n<ul>\n<li>social media APIs for authentication</li>\n<li>keeping the game progress and state</li>\n<li>some storage for a leader board</li>\n<li>deep linking to share results</li>\n</ul>\n<p>I shall call it ‘That’s what who said!?’</p>\n<h2>Getting prepared</h2>\n<p>Let’s get some boilerplate out of the way. First we need to install <a href=\"//nodejs.org\">node</a> and by extension the node package manager (npm). To begin we need to create an npm module using <code class=\"language-text\">npm init</code> that we can store all our other dependencies and configuration against.</p>\n<p>As mentioned earlier we will need to use some tools to allow CommonJS style modules to be used in the browser. There are number of competing projects at the moment, the biggest two being <a href=\"//browserify.org/\">Browserify</a> and <a href=\"//webpack.github.io/\">Webpack</a>. I’m going to use Webpack as it also fulfills some other requirements I have such as building CSS bundles, hot reload etc that would normally require the use of something like Gulp or Grunt.</p>\n<p>We are also going to use React and Express so we will install all of these now.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save webpack express react</code></pre></div>\n<p>We’ll add an npm script for running our local instance. This will get updated in the future but for now this will suffice.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// in package.json</span>\n<span class=\"token operator\">...</span>\n <span class=\"token string\">\"scripts\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"start\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"webpack &amp;&amp; node app/server.js\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>Similarly our webpack configuration will start very simple and get progressively more complex. We will have one client side entry point that will get bundled out to a single file.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  entry<span class=\"token punctuation\">:</span> <span class=\"token string\">'./app/client.js'</span><span class=\"token punctuation\">,</span>\n  output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    path<span class=\"token punctuation\">:</span> <span class=\"token string\">'./assets'</span><span class=\"token punctuation\">,</span>\n    filename<span class=\"token punctuation\">:</span> <span class=\"token string\">'bundle.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Serving Hello World</h2>\n<p>We’ll start by creating a very simple hello world page - first using non-isomorphic techniques and then extend it to be isomorphic.</p>\n<p>For the backend we are using express. This script is adapted from the <a href=\"http://expressjs.com/starter/hello-world.html\">hello world example</a>. It renders a very simple div and a script tag to load our client side script.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/server.js</span>\n<span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// set the static location to the place where webpack will bundle</span>\n<span class=\"token comment\">// the client side scripts to</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span>__dirname <span class=\"token operator\">+</span> <span class=\"token string\">'/../assets/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'&lt;div id=\"app\">Hi&lt;/div>&lt;script src=\"bundle.js\" type=\"text/javascript\">&lt;/script>'</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> server <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> host <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> port <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Example app listening at http://%s:%s'</span><span class=\"token punctuation\">,</span> host<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If we start this up using <code class=\"language-text\">npm run start</code> and then point our browser at <code class=\"language-text\">http://loclahost:3000</code> you should get a page that simply says ‘Hi’ and has a 404 error for <code class=\"language-text\">bundle.js</code>.</p>\n<p>Now let’s write a very simple client side React application.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/client.js</span>\n<span class=\"token keyword\">var</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// I'm intentially not using JSX just yet</span>\nReact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>React<span class=\"token punctuation\">.</span><span class=\"token constant\">DOM</span><span class=\"token punctuation\">.</span><span class=\"token function\">h1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Hello!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This time when <code class=\"language-text\">webpack</code> runs it will follow the dependencies in <code class=\"language-text\">client.js</code> to build a bundle that includes our client side code, the React library, all of its dependencies and an implmentation of <code class=\"language-text\">require</code> that works in the browser.</p>\n<p>Again we will run <code class=\"language-text\">npm run start</code> and go to <code class=\"language-text\">http://localhost:3000</code>. This time you should see a flash of the server rendered ‘Hi’ followed by it being immediately overwritten by the client side ‘Hello!‘.</p>\n<h2>Hello Isomorphic</h2>\n<p>To make the application truly isomorphic we need to be able to render the exact same output on the server and the client. The client should also use progressive enhancement to only update or rewrite as needed when boostrapped. This is where React shines with its isomorphism friendly APIs built in.</p>\n<p>First of all we will need to move our awesome application into it’s own component that can be reused on the client or the server.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/components/app.js</span>\n<span class=\"token keyword\">var</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token constant\">DOM</span><span class=\"token punctuation\">.</span><span class=\"token function\">h1</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Hello!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We then need to update <code class=\"language-text\">client.js</code> to use the new component.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/client.js</span>\n<span class=\"token keyword\">var</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./components/app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nReact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This puts us back in the same place. Running the app still gives a flash of server rendered content before the client rendering kicks in. Let’s update the server code to render the same as the client.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/server.js</span>\n<span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./components/app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// set the static location to the place where webpack will</span>\n<span class=\"token comment\">// bundle the client side scripts up</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span>__dirname <span class=\"token operator\">+</span> <span class=\"token string\">'/../assets/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'&lt;div id=\"app\">'</span> <span class=\"token operator\">+</span>\n      React<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n      <span class=\"token string\">'&lt;/div>&lt;script src=\"bundle.js\" type=\"text/javascript\">&lt;/script>'</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> server <span class=\"token operator\">=</span> app<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> host <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>address<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> port <span class=\"token operator\">=</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">address</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Example app listening at http://%s:%s'</span><span class=\"token punctuation\">,</span> host<span class=\"token punctuation\">,</span> port<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Here we include the same javascript code as the client is using and render it to a string before sending it down the HTTP pipe. When React starts up on the client it will notice that the HTML is the same as what it would need to render and does not overwrite it.</p>\n<p>This time when you run the server you won’t see any flash of server content or any re-rendering.</p>\n<h2>Getting fancy with webpack</h2>\n<p>Webpack can do so much more for us: custom loaders and hot loading being two really interesting ones.</p>\n<p>Whilst in development we will have assets automatically reloaded into the browser, however in production we want assets served from file.</p>\n<h3>Hot loading</h3>\n<p>Before we start hot loading we should first start using a proper HTML template. First we have a few more things to install.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save ejs proxy-middleware webpack-dev-server</code></pre></div>\n<p>This is a really simple ejs template that will use the webpack dev server to load our assets and communicate to the weback dev server for hot loading.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\">&lt;!DOCTYPE html></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>&lt;%= title %><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span>\n      <span class=\"token attr-name\">content</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>viewport<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token punctuation\">/></span></span>\n\n    &lt;%if (settings.env == 'production') { %>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/assets/app.css<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n    &lt;% } %>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>app<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>&lt;%- body %><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n\n    &lt;%if (settings.env != 'production') { %>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>http://localhost:8080/webpack-dev-server.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n    &lt;% } %>\n\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/assets/bundle.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>We need to update the server configuration to pass through assets to the webpack dev server when in development. In production we’ll serve direct from disk. We also need to update the route to serve our new HTML template.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/server.js</span>\n\n<span class=\"token keyword\">var</span> isProduction <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isProduction<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// proxy assets through to webpack-dev-server</span>\n  <span class=\"token keyword\">var</span> url <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'url'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> proxy <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proxy-middleware'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/assets'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">proxy</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://localhost:8080/assets'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// set the static location to the place where webpack will</span>\n  <span class=\"token comment\">// bundle the client side scripts up</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'assets'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/assets'</span><span class=\"token punctuation\">,</span> express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'..'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'assets'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'views'</span><span class=\"token punctuation\">,</span> __dirname <span class=\"token operator\">+</span> <span class=\"token string\">'/views'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">engine</span><span class=\"token punctuation\">(</span><span class=\"token string\">'html'</span><span class=\"token punctuation\">,</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>renderFile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'main.html'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    body<span class=\"token punctuation\">:</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">renderToString</span><span class=\"token punctuation\">(</span><span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    title<span class=\"token punctuation\">:</span> <span class=\"token string\">\"That's what who said!?\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>We now have to tell webpack to supply the dev server files and which <code class=\"language-text\">publicPath</code> to serve them under - this needs to match the path we are proxying above. We do this by adding to the <code class=\"language-text\">entry</code> array as they are served as seperate files.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// webpack.config.js</span>\n<span class=\"token operator\">...</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'./app/client.js'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'webpack/hot/dev-server'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'webpack-dev-server/client?http://localhost:8080'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        path<span class=\"token punctuation\">:</span> <span class=\"token string\">'./assets'</span><span class=\"token punctuation\">,</span>\n        filename<span class=\"token punctuation\">:</span> <span class=\"token string\">\"bundle.js\"</span><span class=\"token punctuation\">,</span>\n        publicPath<span class=\"token punctuation\">:</span> <span class=\"token string\">\"/assets/\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>Next we change the <code class=\"language-text\">start</code> script to use the webpack dev server in hot mode. We’ll add a <code class=\"language-text\">build</code> script as well that will write all the files to the assets directory when invoked. We also need nodemon to monitor the node server and restart on changes and npm-run-all to be able to run our server and webpack in parrallel.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save nodemon npm-run-all</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token comment\">// package.json</span>\n<span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm-run-all --parallel dev server\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"server\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nodemon app/server.js\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack-dev-server --hot --color --progress --devtool source-map\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"webpack -p --config webpack.prod.config.js\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>Now when in development we run <code class=\"language-text\">npm run start</code> and our js files will be served from the webpack dev server on port 8080. You can see the hot loader in action by making a small change to <code class=\"language-text\">app/components/app.js</code> and see the change reflected in the browser almost immediately with no refresh. The console log will also contain some helpful info if or when things go a bit wrong.</p>\n<p>To run a production style build with minified code, dead code removal and all the other good things that webpack does you can use:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">NODE_ENV<span class=\"token operator\">=</span>production <span class=\"token function\">npm</span> run build\nNODE_ENV<span class=\"token operator\">=</span>production node app/server.js</code></pre></div>\n<h3>Using JSX</h3>\n<p>To use JSX in our components we need to use a JSX transpiler. We will use <code class=\"language-text\">jsx-loader</code> with webpack for the front and <code class=\"language-text\">node-jsx</code> on the back. We’ll also include a hot loader specifically for React components.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save node-jsx jsx-loader react-hot-loader</code></pre></div>\n<p>To enable node-jsx in the backend code we simple need to add this to the top of <code class=\"language-text\">app/server.js</code>. Using <code class=\"language-text\">harmony: true</code> will enable ES6 style code in our JSX files.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/server.js</span>\n<span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-jsx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">install</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  harmony<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  extension<span class=\"token punctuation\">:</span> <span class=\"token string\">'.jsx'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>To enable JSX code to be used on the frontend we need to tell webpack how to use <code class=\"language-text\">jsx-loader</code> by adding a module loader to our webpack config that looks for jsx files and puts them through the jsx and react hot loaders. We’ll make sure to also use harmony again for ES6.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// webpack.config.js</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    module<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      loaders<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span> test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.jsx?$/</span><span class=\"token punctuation\">,</span> loaders<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'react-hot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jsx?harmony'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> include<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">// enable React hot module loading</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>HotModuleReplacementPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// don't run the hot loading if a file has an error</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>NoErrorsPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Let’s test this configuration by changing our app React component to use JSX.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// app/components/app.jsx (used to be app/components/app.js)</span>\n<span class=\"token keyword\">var</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'react'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> React<span class=\"token punctuation\">.</span><span class=\"token function\">createClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">render</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Hello<span class=\"token operator\">!</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Stop and restart the dev servers and there should be no change in the applications output.</p>\n<h3>Loading styles</h3>\n<p>Everyone has their own style preference but I like to use SASS and bootstrap as my baseline.</p>\n<p>Here again we can use webpack to simplify the build process and serve up a single file. I’m not completely sold on requiring styles in the javascript components so I will create a single file that is output to <code class=\"language-text\">assets/app.css</code> that our HTML template can load.</p>\n<p>First of all we will need to include SASS, bootstrap and a couple loaders into our project.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> <span class=\"token function\">install</span> --save css-loader sass-loader file-loader boostrap-sass style-loader</code></pre></div>\n<p>First we have to create our main styles page and tell it to include the boostrap files.</p>\n<div class=\"gatsby-highlight\" data-language=\"sass\"><pre class=\"language-sass\"><code class=\"language-sass\"><span class=\"token comment\">// app/styles/app.scss</span>\n<span class=\"token variable-line\"><span class=\"token variable\">$icon-font-path</span><span class=\"token punctuation\">:</span> </span><span class=\"token string\">\"~bootstrap-sass/assets/fonts/bootstrap/\"</span><span class=\"token selector\">;</span>\n<span class=\"token atrule-line\"><span class=\"token atrule\">@import</span> \"~bootstrap-sass/assets/stylesheets/_bootstrap.scss\";</span></code></pre></div>\n<p>It is important to note that the paths must start with <code class=\"language-text\">~</code> but not <code class=\"language-text\">~/</code>. The former will enable the webpack loader to search through it’s list of standard include directories (one of which is node_modules) the latter will look in the users home directory.</p>\n<p>The webpack loader will treat <code class=\"language-text\">@import</code> and <code class=\"language-text\">url(...)</code> in the css files as analogous to <code class=\"language-text\">require()</code>. We will need to set up loaders for some common filetypes in our CSS such as image and font files.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// webpack.config.js</span>\n<span class=\"token operator\">...</span>\n    entry<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'./app/client.js'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'./app/styles/app.scss'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'webpack/hot/dev-server'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'webpack-dev-server/client?http://localhost:8080'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    module<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      loaders<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span> test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.jsx?$/</span><span class=\"token punctuation\">,</span> loaders<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'react-hot'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jsx?harmony'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> include<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span> test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.scss$/</span><span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">:</span> <span class=\"token string\">'style!css?sourceMap!sass?sourceMap'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span> test<span class=\"token punctuation\">:</span> <span class=\"token regex\">/\\.(jpe?g|gif|png|ttf|eot|svg|woff2?)$/</span><span class=\"token punctuation\">,</span> loader<span class=\"token punctuation\">:</span> <span class=\"token string\">\"file\"</span> <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token comment\">// enable React hot module loading</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>HotModuleReplacementPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token comment\">// don't run the hot loading if a file has an error</span>\n      <span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>NoErrorsPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n<span class=\"token operator\">...</span></code></pre></div>\n<p>All our image and font files are passed to file-loader which merely copies them into the output directory. You might prefer to use url-loader for smaller files which inlines them into data uris.</p>\n<p>Our styles are first put through SASS and CSS loaders and then the style loader will create the appropriate link tag in the head of our HTML.</p>\n<p>For production we will need to use the Extract Text plugin which is able to write the results out to the output directory.<sup id=\"fnref-etp\"><a href=\"#fn-etp\" class=\"footnote-ref\">etp</a></sup> If you look through the output generated by <code class=\"language-text\">npm run build</code> it has also changed any <code class=\"language-text\">url()</code> to include the files from the assets directory as well.</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">\n<p>Node is by no means the only option, nor the first. <a href=\"//www.gwtproject.org/\">GWT</a> has been around a long time. More recently there is <a href=\"//github.com/clojure/clojurescript/wiki\">ClojureScript</a> and <a href=\"http://www.typescriptlang.org/\">TypeScript</a></p>\n<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a>\n</li>\n<li id=\"fn-etp\">\n<p>I have not explained the production config in detail here. See <a href=\"https://github.com/alephnullplex/twws/blob/part1/webpack.prod.config.js\">webpack.prod.config.js</a> for more details.</p>\n<a href=\"#fnref-etp\" class=\"footnote-backref\">↩</a>\n</li>\n</ol>\n</div>","fields":{"tagSlugs":["/tags/react/","/tags/javascript/"],"slug":"/posts/isomorphic-react-from-scratch/"},"frontmatter":{"title":"Isomorphic React from Scratch: Hello Isomorphism","tags":["react","javascript"],"date":"2015-05-12T08:47:36Z","description":"This is my journey learning what isomorphic javscript is and how one would go about building a site or application the way the cool kids do."}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/posts/isomorphic-react-from-scratch/"}}